name: Build IPQ U-Boot with Python 2.7

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-ipq-uboot:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout U-Boot repository
      uses: actions/checkout@v4
      with:
        path: u-boot-2016

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          git \
          build-essential \
          flex \
          bison \
          libssl-dev \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          curl \
          wget \
          lsb-release \
          device-tree-compiler \
          libfdt-dev

    - name: Install Miniconda and Python 2.7
      run: |
        # Install Miniconda for Python 2.7
        wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
        bash miniconda.sh -b -p $HOME/miniconda
        echo "$HOME/miniconda/bin" >> $GITHUB_PATH

        # Create a conda environment with Python 2.7
        $HOME/miniconda/bin/conda create -n py27 python=2.7 -y

        # Install pip using get-pip.py
        wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
        $HOME/miniconda/envs/py27/bin/python get-pip.py
        rm get-pip.py

        # 检查pip是否安装成功
        $HOME/miniconda/envs/py27/bin/pip --version

        # Create symbolic links for system-wide access
        sudo ln -sf $HOME/miniconda/envs/py27/bin/python2.7 /usr/local/bin/python2.7
        sudo ln -sf $HOME/miniconda/envs/py27/bin/pip /usr/local/bin/pip2.7

    - name: Verify Python 2.7 installation
      run: |
        python2.7 --version
        pip2.7 --version

    - name: Clone toolchain repository
      run: |
        cd /home/runner/work
        git clone https://github.com/1980490718/toolchain-arm_cortex-a7_gcc-5.2.0.git staging_dir

    - name: Set up toolchain environment
      run: |
        # Set up toolchain environment variables
        TOOLCHAIN_PATH="/home/runner/work/staging_dir/toolchain-arm_cortex-a7_gcc-5.2.0_musl-1.1.16_eabi/bin"
        echo "TOOLCHAIN_PATH=$TOOLCHAIN_PATH" >> $GITHUB_ENV
        echo "PATH=$TOOLCHAIN_PATH:$PATH" >> $GITHUB_ENV
        echo "CROSS_COMPILE=arm-openwrt-linux-" >> $GITHUB_ENV
        echo "ARCH=arm" >> $GITHUB_ENV

        # Verify toolchain installation
        ls -la $TOOLCHAIN_PATH/arm-openwrt-linux-gcc
        $TOOLCHAIN_PATH/arm-openwrt-linux-gcc --version

    - name: Set up Python 2.7 environment for build
      run: |
        # Set up Python 2.7 environment variables for build
        # Warning: Do not set PYTHONHOME, as it will break Python's standard library path
        echo "PYTHONPATH=$HOME/miniconda/envs/py27/lib/python2.7/site-packages" >> $GITHUB_ENV
        echo "PYTHONBIN=$HOME/miniconda/envs/py27/bin/python" >> $GITHUB_ENV
        # Set PYTHON environment variable to ensure Makefile uses correct Python interpreter
        echo "PYTHON=$HOME/miniconda/envs/py27/bin/python" >> $GITHUB_ENV

    - name: Verify dtc installation
      run: |
        dtc --version

    - name: Clean working directory and set timezone
      run: |
        cd u-boot-2016
        # Clean working directory and reset to HEAD
        git reset --hard HEAD
        git clean -fd

        # Create .scmversion file to prevent "dirty" flag
        # Get the current commit hash for version string
        COMMIT_HASH=$(git rev-parse --short HEAD)
        echo "-g${COMMIT_HASH}" > .scmversion
        echo "Set .scmversion to: -g${COMMIT_HASH}"

        echo "Working directory status:"
        git status

        # Set timezone to Asia/Shanghai
        sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
        echo "Current time: $(date)"

    - name: Build U-Boot for all IPQ platforms
      run: |
        cd u-boot-2016

        # Set Python 2.7 as default Python interpreter
        export PYTHON=$HOME/miniconda/envs/py27/bin/python

        # Verify that PYTHON environment variable is set correctly
        echo "PYTHON environment variable: $PYTHON"
        $PYTHON --version

        # Define all supported IPQ types
        IPQ_TYPES=("ipq40xx" "ipq5018" "ipq5332" "ipq6018" "ipq807x" "ipq9574")

        # Build each IPQ type
        for ipq_type in "${IPQ_TYPES[@]}"; do
          echo "================================================"
          echo "Building U-Boot for IPQ type: $ipq_type"
          echo "================================================"
          # Set PYTHON environment variable to ensure build uses Python 2.7
          # Use full Python path to avoid environment variable issues
          echo "PYTHON environment variable: $PYTHON"
          $HOME/miniconda/envs/py27/bin/python --version
          PYTHON=$HOME/miniconda/envs/py27/bin/python ./build.sh "$ipq_type"
        done

        echo "All IPQ platform builds completed!"

    - name: Package each U-Boot file individually with zip ultra compression and timestamp
      run: |
        cd u-boot-2016/bin

        # Get current timestamp (format: YYYYMMDD-HHMMSS)
        TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
        echo "Build timestamp: $TIMESTAMP"

        # Create separate zip packages for each U-Boot image file (with timestamp)
        for file in openwrt-*-u-boot.*; do
          if [ -f "$file" ]; then
            # Extract filename (without extension)
            filename=$(basename "$file" | cut -d. -f1)
            # Create zip package with ultra compression and timestamp in filename
            zip -9 "${filename}-${TIMESTAMP}.zip" "$file"
            echo "Created: ${filename}-${TIMESTAMP}.zip"
          fi
        done

        # Display all created zip files
        ls -la *.zip
        echo "Individual zip packaging with timestamp completed!"

   - name: 发布固件至Release
      uses: softprops/action-gh-release@v1.1.0
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: u-boot-2016/upload/*
        release_name: ${{ env.FILE_DATE }}-${{ env.UPLOAD_TAG_NAME }}
        name: ${{ env.FILE_DATE }}-${{ env.UPLOAD_TAG_NAME }}
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
          Automated U-Boot build for IPQ platforms
          - Built from commit: ${{ github.sha }}
          - Build number: ${{ github.run_number }}
          - Date: ${{ github.event.head_commit.timestamp }}
          - Build timestamp: $TIMESTAMP

          Supported IPQ platforms:
          - ipq40xx
          - ipq5018
          - ipq5332
          - ipq6018
          - ipq807x
          - ipq9574

          Each U-Boot file is individually packaged with ultra compression (zip -9) and timestamp.
        files: u-boot-2016/bin/openwrt-*-u-boot-*.zip
        draft: false
        prerelease: false
